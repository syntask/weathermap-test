<!DOCTYPE html>
<html lang="en">
<head>
    <title>HailMaps.io</title>
    <meta property="og:description" content="HailMaps.io - Intelligent storm tracking and analysis tools." />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@4.3.2/dist/maplibre-gl.js'></script>
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        .maplibregl-ctrl-attrib { display: none !important; }
        #controlContainer { 
            position: absolute; 
            background: white; 
            bottom: 16px; 
            left: 16px; 
            right: 16px; 
            border-radius: 16px; 
            padding: 16px;
            display: flex; 
            align-items: center; 
            flex-wrap: nowrap; 
        }

        #timeSlider {
            width: 100%;
            /* Ensures the slider takes up all the width it can */
            margin: 5px 0;
            /* Adds vertical margin if needed */
            flex-grow: 1;
            /* Allows the slider to grow and take up available space */
        }
    </style>
</head>
<body>
<div id="map"></div>

<div id="controlContainer">
    <div style="display: flex; align-items: center;">
        <label for="date">Date:</label>
        <input type="text" id="date"> <!-- Adjusted to take minimal space -->
    </div>
    <div style="display: flex; align-items: center; flex-grow: 1;">
        <button id="sliderBackward">&lt;</button>
        <button id="sliderForward">&gt;</button>
        <label for="timeSlider">Time:</label>
        <input type="range" id="timeSlider" min="0" max="86399" value="68400" step="120">
    </div>
    <div style="display: flex; align-items: center;">
        <span id="timeDisplay">00:00:00</span>
    </div>
</div>

<script>
    var firstSymbolId;
    var queryDateTime = new Date('2023-08-12T00:00:00Z');

    const timeSlider = document.getElementById('timeSlider');
    const timeDisplay = document.getElementById('timeDisplay');

    function updateDateTime() {
        const timeInSeconds = parseInt(timeSlider.value, 10);
        const hours = Math.floor(timeInSeconds / 3600);
        const minutes = Math.floor((timeInSeconds % 3600) / 60);
        const seconds = timeInSeconds % 60;

        queryDateTime.setHours(hours, minutes, seconds);
        console.log(queryDateTime)
        // Update time display
        timeDisplay.textContent = [hours, minutes, seconds].map(v => v.toString().padStart(2, '0')).join(':');

        updateLayers();
    }

    // Update time part when the slider changes
    timeSlider.addEventListener('input', updateDateTime);


    function replacePlaceholders(text, datetime) {
        // Define replacement patterns
        const replacements = {
            '{{YYYY}}': datetime.getUTCFullYear(),
            '{{mm}}': String(datetime.getUTCMonth() + 1).padStart(2, '0'), // Month is 0-based in JavaScript
            '{{dd}}': String(datetime.getUTCDate()).padStart(2, '0'),
            '{{HH}}': String(datetime.getUTCHours()).padStart(2, '0'),
            '{{MM}}': String(datetime.getUTCMinutes()).padStart(2, '0'),
            '{{SS}}': String(datetime.getUTCSeconds()).padStart(2, '0')
        };

        // Replace each placeholder with the corresponding date/time part
        for (const [placeholder, value] of Object.entries(replacements)) {
            text = text.replace(new RegExp(placeholder, 'g'), value);
        }

        return text;
    }

    function UUID() {
        return Date.now().toString(36) + Math.random().toString(36).substring(2);
    }



    function updateLayers(){
        // HAIL LAYER
        let source = "hailSource"
        let fill = "hailFill"
        let stroke = "hailStroke"
        let tileURL = replacePlaceholders('http://127.0.0.1:5500/backend/data/MRMS/MESHMAX2/{{YYYY}}/{{mm}}/{{dd}}/{{HH}}{{MM}}{{SS}}/tiles/{z}/{x}/{y}.pbf', queryDateTime)
        console.log(tileURL)

        if (map.getSource('hailSource')){
            map.getSource('hailSource').setTiles([tileURL]);
        } else {
            map.addSource(source, {
                type: 'vector',
                tiles: [
                    tileURL
                ],
                minzoom: 0, // Minimum zoom level for the tiles
                maxzoom: 6 // Maximum zoom level for the tiles
            });
    
    
            // Add the fill layer with gradient colors and outline
            map.addLayer({
                id: fill,
                type: 'fill',
                source: source,
                'source-layer': 'layer',
                paint: {
                    'fill-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'value'],
                        0, '#ffff00', // Yellow
                        1, '#ff7f00', // Orange
                        2, '#ff0000', // Red
                        3, '#bb0000', // Dark Red
                    ],
                    'fill-opacity': 0.4, // Opacity of the fill
                    'fill-outline-color': 'rgba(0, 0, 0, 0)', // Color of the stroke
                }
            },
            firstSymbolId
            );
    
    
            // Add the stroke layer
            map.addLayer({
                id: stroke,
                type: 'line',
                source: source,
                'source-layer': 'layer',
                paint: {
                    'line-color': [
                        'interpolate',
                        ['linear'],
                        ['get', 'value'],
                        0, '#ffff00', // Yellow
                        1, '#ff7f00', // Orange
                        2, '#ff0000', // Red
                        3, '#bb0000', // Dark Red
                    ],
                    'line-width': 1.5, // Width of the stroke
                    'line-opacity': 1.0 // Opacity of the stroke
                }
            },
            firstSymbolId
            );
        }



    }

    const map = new maplibregl.Map({
        container: 'map',
        style:
            'https://api.maptiler.com/maps/d856b495-1396-447c-80d5-0fd7fca006e0/style.json?key=uxGPO18AyvxUdEGKe02K',
        center: [-88.13734351262877, 35.137451890638886],
        zoom: 4
    });

    map.on('load', () => {
        const layers = map.getStyle().layers;
        // Find the index of the first symbol layer in the map style
        for (let i = 0; i < layers.length; i++) {
            if (layers[i].type === 'symbol') {
                firstSymbolId = layers[i].id;
                break;
            }
        }

        updateDateTime();
    });
</script>
</body>
</html>